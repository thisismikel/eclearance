<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="referrer" content="origin">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="main.css">
<link rel="stylesheet" href="ol.css">
<style>
	#map {height: 100%; width:100%;}
</style>

</head>
<body>
<div class="container">
	<div id="header1"></div>
	<div id="content">
		
	   <div class="paper paper-polar" >
	   <div class="row">
			<h4 class="text-center">Completed DAR Land Transfer Clearance Applications</h4></div>	
	   </div>
	   <div id="list">
	     
	   
		<div class="row">
			
			
			
					<h3>List of Completed DAR Clearance Applications</h3>
					<div class="table-responsive">
					<table class="table table-hover" id="ds" >
					<thead><tr><th></th><th>Tracking No</th><th>Applicant</th><th>Municipal</th><th>DateFiled</th><th>DateCompleted</th><th>Clearance</th><th>Amend</th></tr></thead>
					<tbody></tbody>
					</table>
					</div>
					<div class="col-xs-12">
							<br>
							<div class="col-xs-12"><span class="pull-right"><button type="button" class="btn btn-default" onclick="showchart()">Chart</button></span></div>
					
					</div>
					
			
			
		</div>
	   </div>
	   <div id="ckeditor" class="row" style="display:none">
				<button class="close" data-dismiss="alert" aria-label="close" onclick="closeck()"><span class="label label-danger">&times;<span></button>
				<h3 class="text-center" id="ckheader"></h3>
				<h5>Applicant Name: <label id="ckapplicant"></label> Property Location: <label id="cklocation"></label></h5>
				<form action="renderLandClearanceController.php" method="post" id="renderform" target="pdfwindow" >
							<input type="hidden" name="lsave" id="lsave" value="0">
							<input type="hidden" name="iddcrform" id="ckiddcrform" >
							<input type="hidden" name="provincial" id="ckprovincial">
							<input type="hidden" name="tk" id="cktk">
							<input type="hidden" name="doctype" id="ckdoctype">
							<textarea name="ckcontent" id="editor" placeholder="Type the content here">
          
							</textarea>
				</form>		
					
		
					<div class="row">
						<div class="col-xs-12">
							<br>
							<button type="button" class="btn btn-primary" onclick="renderthis()">Preview</button>
							<button type="button" class="btn btn-success" onclick="saveCert()">Save</button>
							<br>
							<button type="button" class="btn btn-danger pull-right" onclick="closeck()">Close</button>
						</div>
		
						<div class="col-xs-12">
							<br>
							<div class="alert alert-danger alert-dismissible" role="alert">
								<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
								<strong>Please enable the pop up window</strong>
							</div>
						</div>
					</div>
				
		</div>
	   <div id="details" style="display:none">
			<form name="entryform" id="entryform">
					<fieldset name="myfields" id="myfields" disabled>
								<input type="hidden" name="iddcrform" class="iddcrform">
								<input type="hidden" name="trans" id="trans" class="trans">
								<input type="hidden" name="tk" id="tk" class="tk">
								<input type="hidden" name="officecode" id="officecode">
								<input type="hidden" name="municipal" id="municipal" class="municipal">
								<input type="hidden" name="provincial" id="provincial" class="provincial">
								<input type="hidden" name="regional" id="regional" class="regional">
							<div class="form-group col-sm-12">
								<label>Applicant:</label>
								<input type="text" class="form-control" name="applicant" placeholder="Fullname">
							</div>
							<div class="form-group col-sm-12">
								<label>Address:</label>
								<input type="text" class="form-control" name="address">
							</div>
							<div class="form-group col-sm-12">
								<label>Email:</label>
								<input type="email" class="form-control" name="email">
							</div>
							<div class="form-group col-sm-12">
								<label>Mobile No:</label>
								<input type="text" class="form-control" name="cellno">
							</div>
							<div class="form-group col-sm-12">
								<label>Telephone No:</label>
								<input type="text" class="form-control" name="telno">
							</div>
							<div class="form-group col-sm-12">
								<label>Registered Owner:</label>
								<input type="text" class="form-control" name="registeredowners" placeholder="Registered Owner">
							</div>
							<div class="form-group col-sm-12">
								<label>Title No:</label>
								<input type="text" class="form-control" name="titleno" placeholder="Title No.">
							</div>
							<div class="form-group col-sm-12">
								<label>Area(sqm):</label>
								<input type="number" class="form-control" name="area" min="0" step="any">
							</div>
							<div class="form-group col-sm-12">
								<label>Tax Declaration:</label>
								<input type="text" class="form-control" name="tdno" placeholder="TDno">
							</div>
							<div class="form-group col-sm-12">
								<label>Property Location:</label>
								<input type="text" class="form-control" name="propertylocation" placeholder="Address">
							</div>
							
							<div class="form-group col-sm-12">
								<label>Latitude:</label>
								<input type="number" class="form-control" name="latitude" min="0" step="any">
							</div>
							<div class="form-group col-sm-12">
								<label>Longtitude:</label>
								<input type="number" class="form-control" name="longtitude" min="0" step="any">
							</div>
							
							<div class="form-group col-sm-12">
								<label>Name of Instrument/Conveyance:</label>
								<input type="text" class="form-control" name="instrument" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Transferor:</label>
								<input type="text" class="form-control" name="transferor" placeholder="Enter Name">
							</div>
							<div class="form-group col-sm-12">
								<label>Transferees:</label>
								<input type="text" class="form-control" name="transferees" placeholder="Enter Name">
							</div>
							<div class="form-group col-sm-12">
								<label>Date of Conveyance:</label>
								<input type="date" class="form-control" name="dateconveyance">
								
							</div>
							<div class="form-group col-sm-12">
								<label>Place of Conveyance:</label>
								<input type="text" class="form-control" name="placeconveyance" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Document Number:</label>
								<input type="text" class="form-control" name="docno" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Page Number:</label>
								<input type="text" class="form-control" name="pageno" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Book Number:</label>
								<input type="text" class="form-control" name="bookno" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Year Notarized:</label>
								<input type="number" class="form-control" name="yrnotarized">
							</div>
							<div class="form-group col-sm-12">
								<label>Notary Public:</label>
								<input type="text" class="form-control" name="notarypublic" placeholder="Enter Name">
							</div>
							<div class="col-sm-12">
								<label>Transaction Type:</label>
								<select name="transaction" class="form-control" disabled>
								    <option value="LANDClearance">A.O. 4 - Land Transfer Clearance</option>
								</select>
								
							</div>
											
							<div class="form-group col-sm-12">
								<label>Date Filed:</label>
								<input type="date" class="form-control" name="datefiled" >
							</div>
							<div class="col-sm-12">
								<label><input type="checkbox" name="urgent" value="Y">Urgent</label>
							</div>
							<div class="form-group col-sm-12">
								<label>Reference No.:</label>
								<input type="text" class="form-control" name="referenceno">
							</div>
							
							<div class="col-sm-12">
								<label>Submitted documents:</label><br>
								<div class="col-sm-6">
									<label><input type="checkbox" name="amortization" value="Y">Certificate of Full Payment of Amortization</label><br>
									<label><input type="checkbox" name="nia" value="Y">Certification regarding Full Payment of Irrigation Fees</label>
									<label><input type="checkbox" name="loancert" value="Y">Certification regarding Loans</label>
									<label><input type="checkbox" name="taxclearance" value="Y">Tax clearance</label>
									<label><input type="checkbox" name="affidavittransferor" value="Y">Affidavit of the transferor</label>
								</div>
								<div class="col-sm-6">
									<label><input type="checkbox" name="affidavitaggregate" value="Y">Affidavit of Aggregate Area</label><br>
									<label><input type="checkbox" name="taxreturn" value="Y">Certified copy of Income Tax Return</label>
									<label><input type="checkbox" name="rescert" value="Y">Residence Certificate</label>
									<label><input type="checkbox" name="assessor" value="Y">Certification by the Provincial Assessor's Office</label>
								</div>
							</div>
							<div class="form-group col-sm-12">
								<label>Municipal Office:</label>
								<input type="text" class="form-control" name="municipalname" readonly>
							</div>
							<div class="form-group col-sm-12">
								<label>Provincial Office:</label>
								<input type="text" class="form-control" name="provincialname" readonly>
							</div>
							<div class="form-group col-sm-12">
								<label>Regional Office:</label>
								<input type="text" class="form-control" name="regionalname" readonly>
							</div>
							<div class="form-group col-sm-12">
								<label for="comment">Remarks:</label>
								<textarea class="form-control" rows="5" name="remarks"></textarea>
							</div>
							<div class="form-group col-sm-12">
								<label>Prepared by</label>
								<input type="text" class="form-control" name="preparedby" placeholder="Enter fullname" >
							</div>
							
							
							
					</fieldset>
					<div class="col-xs-12"><button type="button" class="btn btn-info btn-sm" onclick="showmap(this.form)">View Map</button></div>
					
					
			</form>
			<div class="col-xs-6" id="divattachment">
						<div class="col-xs-12">
							<h5>Attachment/s:</h5>
							<button type="button" class="btn btn-default" onclick="addimages();return false;" id="attachmentbutton">Add Image (max image size is 3mb)</button>
							<br><br>
						</div>
						<div class="col-xs-12">
							<div id="divimages"></div>
						</div>
			</div>
			<div class="col-xs-6" id="landclearance">
						
						
						
						<div class="col-xs-12">
						
							<h5>Acknowledgement Receipt:</h5>
							<button class="btn btn-default btn-xs marpo" type="button" onclick="Uploadar()">Create Acknowledgement Receipt</button>
							<div class="col-xs-12" id="divar"></div>
							
							
						
						</div>


						
			</div>
		</div>
	  
		
		
	   
	</div>
</div>
<div id="header"></div>

<div id="mChart" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg" role="document">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
		  <div id="content" class="col-xs-12">
			<canvas id="myChart" width="100%" ></canvas>
		</div>
	  </div>
      
    </div>

  </div>
</div>



<div id="myMap" class="modal" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
		<div class="row"><div id="map" class="map"></div><div id="popup"></div></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
</div>
<div id="myPDF" class="modal" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
		<div id="pdfshow"></div>
		
      
    </div>

  </div>
</div>
</div>
<div id="myReason" class="modal" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
		<h6>Enter Reason/s for Amendment</h6>
      </div>
      <div class="modal-body">
		<form id="frmReason">
			<input type="hidden" name="iddcrform">
			<input type="hidden" name="idtrackform">
			<input type="hidden" name="provincial">
			<input type="hidden" name="officename">
			<input type="hidden" name="trans" value="forDARPO">	
			<input type="hidden" name="tk">
			<div class="form-group col-xs-12">
				<div class="form-group">
					<textarea class="form-control" name="details" rows="3"></textarea>
				</div>		
								
			</div>
			<button type="button" class="btn btn-primary" onclick="saveReason(this.form)">Submit</button>
			
		</form>
		
      
    </div>
		<div class="modal-footer">
			<button type="button" class="btn-danger" data-dismiss="modal">Close</button>
		</div>
  </div>
</div>
</div>
<section><div id="attachmentdiv"></div></section>
</body>
<script src="jquery.min.js"></script>
<script src="bootstrap.min.js"></script>
<script src="jquery.dataTables.min.js"></script>
<script src="Buttons/js/buttons.print.min.js"></script>
<script src="ol.js"></script>
<script src="jquery.toaster.js"></script>
<script src="bootbox.min.js"></script>
<script src="Chart.bundle.min.js"></script>
<script src="main1.js"></script>
<script src="pdfobject.min.js"></script>
<script src="ckeditor/build/ckeditor.js"></script>
<script>
ClassicEditor
			.create( document.querySelector( '#editor' ), {
				
				toolbar: {
					items: [
						'heading',
						'|',
						'bold',
						'italic',
						'link',
						'bulletedList',
						'numberedList',
						'|',
						'outdent',
						'indent',
						'|',
						'imageUpload',
						'blockQuote',
						'insertTable',
						'mediaEmbed',
						'undo',
						'redo',
						'CKFinder',
						'alignment',
						'fontBackgroundColor',
						'fontColor',
						'fontSize',
						'fontFamily',
						'highlight',
						'horizontalLine',
						'pageBreak',
						'removeFormat',
						'specialCharacters',
						'strikethrough',
						'subscript',
						'superscript',
						'underline',
						'lineHeight'
					]
				},
				language: 'en',
				image: {
					toolbar: [
						'imageTextAlternative',
						'imageStyle:full',
						'imageStyle:side'
					]
				},
				table: {
					contentToolbar: [
						'tableColumn',
						'tableRow',
						'mergeTableCells',
						'tableCellProperties',
						'tableProperties'
					]
				},
				licenseKey: '',
				ckfinder: {openerMethod: 'popup'}
				
			} )
			.then( editor => {
				window.editor = editor;
				
			} )
			.catch( error => {
				console.error( error );
			} );
let stemplate2 ='';
function startload() {
	
	
	var tk=qs['tk'];
	var today = new Date();
	var asDate = new Date();
	var options = { year: 'numeric', month: 'long', day: 'numeric' };
	var stoday = today.toLocaleDateString("en-US", options);
	var caption = "As of "+ asDate.toLocaleDateString("en-US", options);
	var table = $('#ds').DataTable( {"destroy":true,
		"dom": 'lfrtBip', 
		"buttons": [
            "copy", 
			{extend:"excelHtml5","title" : "List of Completed DAR Clearance Applications", "messageTop": caption, "messageBottom": "\n Prepared by: "+ fullname + " " +stoday, "footer":true}, 
			{extend: 'pdf', 
			title : 'List of Completed DAR Clearance Applications'
			, messageTop: caption, messageBottom: '\n Prepared by: '+ fullname + ' ' +stoday, footer:true},
			{extend: 'print',
			title : 'List of Completed DAR Clearance Applications',
			 messageTop: caption, messageBottom: '\n Prepared by: '+ fullname + ' ' +stoday, footer:true
			
			}
        ],
		"ajax": "clearanceController.php?trans=getdetails&tk="+tk,
        "columns": [
            {"className":      'details-control',
												 "orderable":      false,
												 "data":           null,
												 "defaultContent": ''},
			{ "data": "iddcrform"},
			{ "data": "applicant"},
			{ "data": "municipalname"},
			{ "data": "datefiled"},
			{ "data": "startdate"},
			{ "className":'details2',"defaultContent": '<span class="glyphicon glyphicon-print"></span>'},
			{ "className":'details',"defaultContent": '<span class="glyphicon glyphicon-pencil"></span>'}
			
        ],
        "order": [[3, 'desc']]
    } );
	
	
	$('#ds tbody').off('click');
	$('#ds tbody').on('click', 'td.details-control', function () {
		
         var tr = $(this).closest('tr');
        var row = table.row( tr );
 
        if ( row.child.isShown() ) {
           
				row.child.hide();
				tr.removeClass('shown');
       }
		
        else {
            if ( table.row( '.shown' ).length ) {
                  
				  $('.maindiv').hide();
				  $( '.shown' ).removeClass('shown');
			}
            row.child( format(row.data())).show();
            tr.addClass('shown');
			getchild(row.data());
        }
		
    } );
	
	$('#ds tbody').on('click', 'td.details2', function () {
		 let tr = $(this).closest('tr');
         let row = table.row( tr );
		 printclearance(row.data());
	});
	$('#ds tbody').on('click', 'td.details', function () {
		 let tr = $(this).closest('tr');
         let row = table.row( tr );
		
		 amenddoc(row.data());
	});
	
	 
	startattachment();
	uploadtemplate2();
	initload();
}


function printclearance(d){
let x = d['iddcrform'];

let params = 'menubar=no,width=0, height=0`,location=no, status=no, toolbar=no';
let tk=qs['tk'];
	window.open('chieflegalController.php?iddcrform='+x+"&tk="+tk+"&trans=showpdf",'pdfwindow',params);
}

function amenddoc(row){

bootbox.confirm({
    message: 'Request to Amend Tracking No.: '+row['iddcrform']+'?',
    buttons: {
        confirm: {
            label: 'Yes',
            className: 'btn-danger'
        },
        cancel: {
            label: 'No',
            className: 'btn-default'
        }
    },
    callback: function (result) {
        if (result){
			$("#myRoute").modal("show");
			var tk=qs['tk'];
			
			let f = document.getElementById('frmReason');
			f.elements.namedItem('iddcrform').value = row['iddcrform'];
			f.elements.namedItem('idtrackform').value = row['idtrackform'];
			f.elements.namedItem('provincial').value = row['provincial'];
			f.elements.namedItem('officename').value = row['provincialname'];
			f.elements.namedItem('tk').value = qs['tk'];
			$("#myReason").modal("show");
			

		}
    }
});
}
function saveReason(tform){
$("#myReason").modal("hide");
let data = $(tform).serialize();
$.get("darmoController.php",data,
										function(d){
											var officecode = d['officecode'];
											var role = d['role'];
											var iddcrform = d['iddcrform'];
											var officename =d['officename'];
											$.get("sendController.php",{"officecode":officecode,"role":role,"iddcrform":iddcrform,"officename":officename});
											$.toaster({ priority : 'success', title : 'Clearance', message : 'Record forwarded for Amendment'});
									        $('#ds').DataTable().ajax.reload(null,false);
											$("#myRoute").modal("hide");
										},'json');
}
function format(row){
var iddcrform = row['iddcrform'];
var track = "track"+row['iddcrform'];

var elem = document.getElementById(iddcrform);
if (elem){
  elem.parentNode.removeChild(iddcrform);
}
var elem2 = document.getElementById(track);
if (elem2){
  elem2.parentNode.removeChild(track);
}
  return '<div class="maindiv"><div class="col-xs-12 well" id="'+iddcrform+'"></div><div class="col-xs-12 well" id="'+track+'"></div></div>';
}

function getchild(data){
var iddcrform = '#'+data['iddcrform'];

var tform = document.getElementById('form'+data['iddcrform']);
if (tform){
	tform.parentNode.removeChild('form'+data['iddcrform']);
}
var nform = $('#entryform').clone(true).prop('id','form'+data['iddcrform']);
nform.appendTo( iddcrform );
var x = document.getElementById('form'+data['iddcrform']);

	
	x.elements.namedItem('tk').value=qs['tk'];
	x.elements.namedItem('trans').value='UPDATE';
	x.elements.namedItem('iddcrform').value=data['iddcrform'];
	x.elements.namedItem('municipal').value=data['municipal'];
	x.elements.namedItem('provincial').value=data['provincial'];
	x.elements.namedItem('regional').value=data['regional'];
	x.elements.namedItem('municipalname').value=data['municipalname'];
	x.elements.namedItem('provincialname').value=data['provincialname'];
	x.elements.namedItem('regionalname').value=data['regionalname'];
	x.elements.namedItem('address').value= data['address'];
	x.elements.namedItem('applicant').value= data['applicant'];
	x.elements.namedItem('email').value= data['email'];
	x.elements.namedItem('cellno').value= data['cellno'];
	x.elements.namedItem('telno').value= data['telno'];
	x.elements.namedItem('transaction').value= data['transaction'];
	x.elements.namedItem('propertylocation').value= data['propertylocation'];
	x.elements.namedItem('longtitude').value= data['longtitude'];
	x.elements.namedItem('latitude').value= data['latitude'];
	x.elements.namedItem('referenceno').value= data['referenceno'];
	x.elements.namedItem('transaction').value= data['transaction'];
	x.elements.namedItem('remarks').value= data['remarks'];
	x.elements.namedItem('preparedby').value= data['preparedby'];
	x.elements.namedItem('datefiled').value= data['datefiled'];
	if (data['urgent']=='Y'){
		x.elements.namedItem('urgent').checked = true;
	} else {
		x.elements.namedItem('urgent').checked = false;
	}
	if (data['amortization']=='Y'){
		x.elements.namedItem('amortization').checked = true;
	} else {
		x.elements.namedItem('amortization').checked = false;
	}
	if (data['nia']=='Y'){
		x.elements.namedItem('nia').checked = true;
	} else {
		x.elements.namedItem('nia').checked = false;
	}
	if (data['taxclearance']=='Y'){
		x.elements.namedItem('taxclearance').checked = true;
	} else {
		x.elements.namedItem('taxclearance').checked = false;
	}
	if (data['affidavittransferor']=='Y'){
		x.elements.namedItem('affidavittransferor').checked = true;
	} else {
		x.elements.namedItem('affidavittransferor').checked = false;
	}
	if (data['affidavitaggregate']=='Y'){
		x.elements.namedItem('affidavitaggregate').checked = true;
	} else {
		x.elements.namedItem('affidavitaggregate').checked = false;
	}
	if (data['loancert']=='Y'){
		x.elements.namedItem('loancert').checked = true;
	} else {
		x.elements.namedItem('loancert').checked = false;
	}
	if (data['taxreturn']=='Y'){
		x.elements.namedItem('taxreturn').checked = true;
	} else {
		x.elements.namedItem('taxreturn').checked = false;
	}
	if (data['rescert']=='Y'){
		x.elements.namedItem('rescert').checked = true;
	} else {
		x.elements.namedItem('rescert').checked = false;
	}
	if (data['assessor']=='Y'){
		x.elements.namedItem('assessor').checked = true;
	} else {
		x.elements.namedItem('assessor').checked = false;
	}
	
	x.elements.namedItem('myfields').disabled = true;
	x.elements.namedItem('registeredowners').value= data['registeredowners'];
	x.elements.namedItem('titleno').value= data['titleno'];
	x.elements.namedItem('area').value= data['area'];
	x.elements.namedItem('tdno').value= data['tdno'];
	x.elements.namedItem('instrument').value= data['instrument'];
	x.elements.namedItem('transferor').value= data['transferor'];
	x.elements.namedItem('transferees').value= data['transferees'];
	x.elements.namedItem('dateconveyance').value= data['dateconveyance'];
	x.elements.namedItem('placeconveyance').value= data['placeconveyance'];
	x.elements.namedItem('docno').value= data['docno'];
	x.elements.namedItem('pageno').value= data['pageno'];
	x.elements.namedItem('bookno').value= data['bookno'];
	x.elements.namedItem('yrnotarized').value= data['yrnotarized'];
	x.elements.namedItem('notarypublic').value= data['notarypublic'];
	    //x.elements.namedItem('lotno').value= data['lotno'];
	var nform = $('#divattachment').clone(true);
	nform.appendTo( iddcrform );
	document.getElementById('divattachment').style.display = "block";
	document.getElementById('keyvalue').value = data['iddcrform'];
	document.getElementById('keyname').value = 'iddcrform';
	getattachments(data['iddcrform'],true);
	
	document.getElementById('ckiddcrform').value = data['iddcrform'];
	document.getElementById('cktk').value = qs['tk'];
	document.getElementById('ckapplicant').innerHTML = data['applicant'];
	document.getElementById('cklocation').innerHTML = data['propertylocation'];
	let xorderform = $('#landclearance').clone(true);
	xorderform.appendTo( iddcrform );
	document.getElementById('landclearance').style.display ="block";
	getcert(data);
	initload();
	getcase(data['iddcrform'],data['municipal'],data['regional'],data['provincial']);
}
function getcase(iddcrform,municipal,regional,provincial){
var tk=qs['tk'];
$.get("darpoController.php",{trans:"getcase","tk":tk,"iddcrform":iddcrform,"municipal":municipal,"regional":regional,"provincial":provincial},function(data){
										var nlast = data['trackform'].length-1;
										
										var bfound = false;
										var scontent ='';
										
										var nlength = data['trackform'].length
										var today = new Date(); 
										var municipal = data['municipal'];
										var regional = data['regional'];
										for(i=0; i < nlength; i++){
										
											var row = data['trackform'][i];
											bfound = true;
											if (nlast == i){
												scontent +="<div class='col-xs-12 well'>";
												
												var startdate = new Date(row['startdate']);
												var duration = datedifference(startdate, today,15,'DAYS');
												if (row['status']=='DARPO'){
													duration = datedifference(startdate, today,10,'DAYS');
												}
												if (row['status']=='LEGAL' || row['status']=='APPROVAL' || row['status']=='DISAPPROVAL'){
													duration = datedifference(startdate, today,5,'DAYS');
												}
												scontent +="<label><small>Office: </small><span class='label label-info'>"+row['officename']+"</span></label><br>";
												scontent += "<label><small>Status:</small> "+row['status']+"  <small>Date :</small> "+row['startdate']+"  <small>Duration:</small> "+ duration+ "</label><br>";
												if (row['firstseen']==1) {scontent += "<label><small>First Seen by:</small> <span class='label label-default'> "+row['firstseen']+" </span> - ";}
												scontent += "<label>Details :</label>";
												var sdetails = row['details'];
												if (!sdetails) {sdetails ='';}
												scontent += '<p>'+sdetails+'</p>';
												scontent += '</div>';
												iddcrform = row['iddcrform'];
											} else {
												scontent += '<div class="col-xs-12 well">';
												var startdate = new Date(row['startdate']);
												var enddate = new Date(row['enddate']);
												var duration = datedifference(startdate, enddate);
												scontent +="<label><small>Office: </small><span class='label label-info'>"+row['officename']+"</span></label><br>";
												scontent += "<label><small>Status:</small> "+row['status']+"  <small>Period from: </small>"+row['startdate']+" to "+ row['enddate']+ "  <small> Elapsed Time:</small> "+ duration+ "</label><br>";
												if (row['firstseen']==1) {scontent += "<label><small>First Seen by:</small> <span class='label label-default'> "+row['firstseen']+" </span> - ";}
												scontent += "<label><small>Processed by: </small></label> <span class='label label-default'> "+row['fullname']+" </span><br>";
												scontent += "<label>Details: </label>";
												scontent += "<p>"+row['details']+"</p>";
												scontent += '</div>';
											}
											
										}
										if (bfound){
												document.getElementById('track'+iddcrform).innerHTML = scontent;
												initload();
											}
										},'json');
}

function showmap(thisform){
$("#myMap").modal("show");
	var lat = thisform.elements.namedItem('latitude').value;
	var lon = thisform.elements.namedItem('longtitude').value;
	
	var propertylocation = thisform.elements.namedItem('propertylocation').value;
	if (lat == 0 && lon == 0){
		lat = 7.07221;
		
		//7.0567022;
		//
		lon = 125.52210;
		//125.6016536;
		//
		propertylocation = "Department Of Agrarian Reform Regional Office XI";
		
	}
	
	
	
	var layer = new ol.layer.Vector({
     source: new ol.source.Vector({
         features: [
             new ol.Feature({
                 geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat]))
             })
         ]
			 
		})
		
	 });
	var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([lon, lat]),
          zoom: 17
        })
		
      });
	
	
	 var container = document.getElementById('popup');
	 

	var overlay = new ol.Overlay({
     element: container,
     autoPan: true,
     autoPanAnimation: {
         duration: 250
     }
 });
 
	map.addOverlay(overlay);
	container.innerHTML = '<img src="images/marker.png"><b>'+propertylocation+'</b>';
	overlay.setPosition(ol.proj.fromLonLat([lon, lat]));

}


function cancelthis(thisform){
	$('#ds').DataTable().ajax.reload(null,false);
	
}
function showchart(){
var tk = qs['tk'];
$.get("completedController.php?trans=getchart&tk="+tk,function(data){graph1(data);},'json');

}
function graph1(data){
var ctx = document.getElementById('myChart');
var d=data['chart'];
var alabels=[];
var avalues=[];
var abackground=[];
var aforecolor=[];
for (var i = 0; i < d.length; i++) {
	var row = d[i];
	var r= Math.floor(Math.random() * 256);  
	var g=Math.floor(Math.random() * 256);  
	var b=Math.floor(Math.random() * 256);  
    alabels.push(row['officecode']);
	avalues.push(row['documents']);
	abackground.push('rgba('+r+','+g+','+b+'0.2)');
	//aforecolor.push('rgba(255, 99, 10, 1)');
	
}

var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: alabels,
        datasets: [{
            label: '# Completed Applications',
            data: avalues,
            backgroundColor: abackground,
            //borderColor: aforecolor,
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    }
});
$('#mChart').modal('show');
}
function uploadtemplate2(){
let tk = qs['tk'];
$.get('chieflegalController.php',{"trans":"loadtemplate2","tk":tk}, function (d){
		let data = d['template'];
		stemplate2 = data;
	},'json');
}
function Uploadar(){
document.getElementById('ckheader').innerHTML="ACKNOWLEDGEMENT RECEIPT";
let iddcrform = document.getElementById('ckiddcrform').value;
let x = document.getElementById('form'+iddcrform);

document.getElementById('ckdoctype').value ="ar";
document.getElementById('list').style.display = "none";
document.getElementById('ckeditor').style.display = "block";
document.body.scrollTop = 0; // For Safari
document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
let xapplicant = x.elements.namedItem('applicant').value;
let xdate = new Date();
let xday = xdate.toLocaleString('default',{day:'numeric'});
let xmonth = xdate.toLocaleString('default',{month:'long'});
let xyear = xdate.toLocaleString('default',{year:'numeric'});
let content = stemplate2.replace("$applicant",xapplicant);
let xsub = "th";
if (xday==1 ||  xday==21 || xday==31) { xsub="st";}
else if (xday==2 || xday==22) {xsub="nd";}
else if (xday==3 || xday==23) {xsub="rd";}
else if (xday>=4 && xday<=20) {xsub="th";}
else if (xday>=24 && xday<=30) {xsub="th";}

content = content.replace("$day",xday+xsub);
content = content.replace("$month",xmonth);
content = content.replace("$year",xyear);
//content = content.replace("$municipaladdress",xlocation);
content = content.replace("$preparedby",fullname);
editor.setData(content);

}
function renderthis(){
	document.getElementById("ckprovincial").value = soffice;
	let params = 'menubar=no,width=0, height=0`,location=no, status=no, toolbar=no';
	document.getElementById('lsave').value = "0";
	window.open('','pdfwindow',params);
	document.getElementById("renderform").submit();
	
}
function saveCert(){
	document.getElementById("ckprovincial").value = soffice;
	let params = 'menubar=no,width=0, height=0`,location=no, status=no, toolbar=no';
	document.getElementById('lsave').value = "1";
	window.open('','pdfwindow',params);
	document.getElementById("renderform").submit();
	bootbox.alert('Land Transfer Clearance saved');
	let iddcrform = document.getElementById('ckiddcrform').value;
	//getcert2(iddcrform);
	
}
function getcert(data){
//let tk = qs['tk'];

//$.get("darmoController.php",{"trans":"getcert","tk":tk,"iddcrform":iddcrform},function(data){
											
											let areceipt = data['areceipt'];
											let scontentar ='';
											if (areceipt=='null'){areceipt='';}
											if (areceipt){
												
												let iddcrform = "'"+data['iddcrform']+"'";
												let docdetar ="'"+data['areceipt']+"','"+data['iddcrform']+"','ar'";
												
												scontentar += '<span class="glyphicon glyphicon-file"></span><button type="button" onclick="showpdfar('+iddcrform+')" class="btn btn-link">'+data['areceipt']+'</button>';
												if (data['signedar']=='0'){
													scontentar += '<button type="button" onclick="signpdf('+docdetar+')" class="btn btn-primary btn-xs">Sign</button>';
												}
												scontentar += '<button type="button" onclick="deletepdfar('+iddcrform+')" class="btn btn-danger btn-xs">Remove</button><br>';
												
											}
											
											
											document.getElementById('divar').innerHTML = scontentar;
//										},'json');
}
function getcert2(iddcrform){
let tk = qs['tk'];

$.get("chieflegalController.php",{"trans":"getcert","tk":tk,"iddcrform":iddcrform},function(data){
											
											let areceipt = data['areceipt'];
											let scontentar ='';
											if (areceipt=='null'){areceipt='';}
											if (areceipt){
												
												let iddcrform = "'"+data['iddcrform']+"'";
												let docdetar ="'"+data['areceipt']+"','"+data['iddcrform']+"','ar'";
												
												scontentar += '<span class="glyphicon glyphicon-file"></span><button type="button" onclick="showpdfar('+iddcrform+')" class="btn btn-link">'+data['areceipt']+'</button>';
												if (data['signedar']=='0'){
													scontentar += '<button type="button" onclick="signpdf('+docdetar+')" class="btn btn-primary btn-xs">Sign</button>';
												}
												scontentar += '<button type="button" onclick="deletepdfar('+iddcrform+')" class="btn btn-danger btn-xs">Remove</button><br>';
												
											}
											document.getElementById('divar').innerHTML = scontentar;
										},'json');
}

function showpdfar(iddcrform){
let params = 'menubar=no,width=0, height=0`,location=no, status=no, toolbar=no';
let tk=qs['tk'];
	window.open('chieflegalController.php?iddcrform='+iddcrform+"&tk="+tk+"&trans=showpdfar",'pdfwindow',params);
}

function signpdf(filename,iddcrform, doctype){
let keyword = fullname;
$("#mySign").modal("show");
$.get("searchpdfController3.php",{"tk":tk,"keyword":keyword,"filename":filename,"iddcrform":iddcrform,"doctype":doctype},function(data){
											let page = data;
											if(page['pagenumber']>0 ){
												
													let x = page['cX'];
													let y = page['cY'];
													let filename = page['filename'];
													let signature = signimage;
													let iddcrform = page['iddcrform'];
													let pagenumber = page['pagenumber'];
													let idorderdoc = page['idorderdoc'];
													let doctype=page['doctype'];
													if (!signature){
														$("#mySign").modal("hide");
														bootbox.alert('Failed to sign. User signature not registered');
														
													} else {
														let tk = qs['tk'];
														$.get("signdocController3.php",{"tk":tk,"x":x,"y":y,"filename":filename,"pagenumber":pagenumber,"sigimage":signature,"iddcrform":iddcrform,"tk":tk,"fullname":fullname,"doctype":doctype},function(data){
															$("#mySign").modal("hide");
															bootbox.alert('Document signed');
															getcert2(data['iddcrform']);
															
														},'json');
													}
											
											
											}else {
													$("#mySign").modal("hide");
													bootbox.alert('Failed to sign. Signatory name not found');
													
											}},'json');


}
function deletepdfar(iddcrform){
let tk = qs['tk'];
bootbox.confirm({
    message: 'Delete this document?',
    buttons: {
        confirm: {
            label: 'Yes',
            className: 'btn-danger'
        },
        cancel: {
            label: 'No',
            className: 'btn-default'
        }
    },
    callback: function (result) {
        if (result){
			$.get("chieflegalController.php",{"trans":"deletepdfar","tk":tk,"iddcrform":iddcrform},function(data){
											bootbox.alert('Document Deleted');
											getcert2(data['iddcrform']);
											},'json');


		}
    }
});
}
function closeck(){
let iddcrform = document.getElementById('ckiddcrform').value;
	getcert2(iddcrform);
document.getElementById('list').style.display = "block";
document.getElementById('ckeditor').style.display = "none";
}
</script>
<script src="attachment.js"></script>