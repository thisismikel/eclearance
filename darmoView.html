<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="referrer" content="origin">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" sizes="57x57" href="images/icon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="images/icon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="images/icon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="images/icon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="images/icon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="images/icon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="images/icon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="images/icon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="images/icon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="images/icon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="images/icon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="images/icon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/icon/favicon-16x16.png">
<link rel="manifest" href="images/icon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="main.css">
<link rel="stylesheet" href="ol.css">
<style>
	#map {height: 100%; width:100%;}
</style>

</head>
<body>
<div class="container">
	<div id="header1"></div>
	<div id="content">
		
	   <div class="paper paper-polar" >
	   <div class="row">
			<h4 class="text-center">DARMO</h4></div>	
	   </div>
	   <div id="list">
	     
	   
		<div class="row">
			<div class="paper paper-polar" >
			<div class="row">
			<div class="col-xs-12">
					<h3>List of Encoded Applications</h3>
					<div class="col-xs-12 text-right"><button type="button" onclick="refresh()"  class="btn btn-primary" data-toggle="tooltip" title="Refresh"><span class="glyphicon glyphicon-refresh"></span></button> <button type="button" onclick="additem()"  class="btn btn-primary" data-toggle="tooltip" title="Add New Application"><span class="glyphicon glyphicon-plus"></span></button></div>
					<table class="table table-hover" id="ds" style="width:100%">
					<thead><tr><th></th><th>Tracking No</th><th>Applicant</th><th>Transaction</th><th>Date</th><th></th><th></th><th></th></tr></thead>
					<tfoot><tr><th></th><th>Tracking No</th><th>Applicant</th><th>Transaction</th><th>Date</th><th></th><th></th><th></th></tr></tfoot>
					<tbody></tbody>
					</table>
					<div class="col-xs-12">
							<br>
							<div class="pull-right"><button type="button" onclick="additem()" class="btn btn-primary" data-toggle="tooltip" title="Add New Application"><span class="glyphicon glyphicon-plus"></span></button></div>	
							<br>
					</div>
				</div>	
			</div>
			</div>
		</div>
	   </div>	
		<div id="ckeditor" class="row" style="display:none">
				<button class="close" data-dismiss="alert" aria-label="close" onclick="closeck()"><span class="label label-danger">&times;<span></button>
				<h3 class="text-center">MARPO Certification</h3>
				<h5>Applicant Name: <label id="ckapplicant"></label> Property Location: <label id="cklocation"></label></h5>
				<form action="renderMarpoController.php" method="post" id="renderform" target="pdfwindow" >
							<input type="hidden" name="lsave" id="lsave" value="0">
							<input type="hidden" name="iddcrform" id="ckiddcrform" >
							<input type="hidden" name="tk" id="cktk">
							<textarea name="ckcontent" id="editor" placeholder="Type the content here">
          
							</textarea>
				</form>		
					
		
					<div class="row">
						<div class="col-xs-12">
							<br>
							<button type="button" class="btn btn-primary" onclick="renderthis()">Preview</button>
							<button type="button" class="btn btn-success" onclick="saveCert()">Save</button>
							<br>
							<button type="button" class="btn btn-danger pull-right" onclick="closeck()">Close</button>
						</div>
		
						<div class="col-xs-12">
							<br>
							<div class="alert alert-danger alert-dismissible" role="alert">
								<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
								<strong>Please enable the pop up window</strong>
							</div>
						</div>
					</div>
				
		</div>
	   <div id="details" style="display:none">
			<form name="entryform" id="entryform" onsubmit="event.preventDefault(); savethis(this)">
					<fieldset name="myfields" id="myfields" disabled>
								<input type="hidden" name="iddcrform" class="iddcrform">
								<input type="hidden" name="trans" id="trans" class="trans">
								<input type="hidden" name="tk" id="tk" class="tk">
								<input type="hidden" name="officecode" id="officecode">
								<input type="hidden" name="municipal" id="municipal" class="municipal">
								<input type="hidden" name="provincial" id="provincial" class="provincial">
								<input type="hidden" name="regional" id="regional" class="regional">
								<input type="hidden" name="transaction1">
							<div class="form-group col-sm-12">
								<label>Applicant:</label>
								<input type="text" class="form-control" name="applicant" placeholder="Lastname, Firstname Middlename" required onchange="onchangeapplicant(this)">
							</div>
							<div class="form-group col-sm-12">
								<label>Address:</label>
								<input type="text" class="form-control" name="address" placeholder="Applicant's Address" required>
							</div>
							<div class="form-group col-sm-12">
								<label>Email:</label>
								<input type="email" class="form-control" name="email">
							</div>
							<div class="form-group col-sm-12">
								<label>Mobile No:</label>
								<input type="tel" class="form-control" name="cellno" placeholder="09123456789" pattern="[0][9][0-9]{9}">
							</div>
							<div class="form-group col-sm-12">
								<label>Telephone No:</label>
								<input type="tel" class="form-control" name="telno" placeholder="0821234567" pattern="[0][0-9]{2}[0-9]{7}">
							</div>
							<div class="form-group col-sm-12">
								<label>Registered Owner:</label>
								<input type="text" class="form-control" name="registeredowners" placeholder="Registered Owner" required>
							</div>
							<div class="form-group col-sm-12">
								<label>Title No:</label>
								<input type="text" class="form-control" name="titleno" placeholder="Title No." required>
							</div>
							<div class="form-group col-sm-12">
								<label>Area(sqm):</label>
								<input type="number" class="form-control" name="area" min="0" step="any" required>
							</div>
							<div class="form-group col-sm-12">
								<label>Tax Declaration:</label>
								<input type="text" class="form-control" name="tdno" placeholder="TDno">
							</div>
							<div class="form-group col-sm-12">
								<label>Property Location:</label>
								<input type="text" class="form-control" name="propertylocation" placeholder="Address" required onchange="onchagelocation(this)">
							</div>
							
							<div class="form-group col-sm-12">
								<label>Latitude:</label>
								<input type="number" class="form-control" name="latitude" min="0" step="any">
							</div>
							<div class="form-group col-sm-12">
								<label>Longtitude:</label>
								<input type="number" class="form-control" name="longtitude" min="0" step="any">
							</div>
							<div class="col-xs-12"><button type="button" class="btn btn-info" onclick="showmap(this.form)">View Map</button></div>
							<div class="form-group col-sm-12">
								<label>Name of Instrument/Conveyance:</label>
								<input type="text" class="form-control" name="instrument" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Transferor:</label>
								<input type="text" class="form-control" name="transferor" placeholder="Enter Name">
							</div>
							<div class="form-group col-sm-12">
								<label>Transferees:</label>
								<input type="text" class="form-control" name="transferees" placeholder="Enter Name">
							</div>
							<div class="form-group col-sm-12">
								<label>Date of Conveyance:</label>
								<input type="date" class="form-control" name="dateconveyance">
								
							</div>
							<div class="form-group col-sm-12">
								<label>Place of Conveyance:</label>
								<input type="text" class="form-control" name="placeconveyance" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Document Number:</label>
								<input type="text" class="form-control" name="docno" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Page Number:</label>
								<input type="text" class="form-control" name="pageno" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Book Number:</label>
								<input type="text" class="form-control" name="bookno" placeholder="Enter Details">
							</div>
							<div class="form-group col-sm-12">
								<label>Year Notarized:</label>
								<input type="number" class="form-control" name="yrnotarized">
							</div>
							<div class="form-group col-sm-12">
								<label>Notary Public:</label>
								<input type="text" class="form-control" name="notarypublic" placeholder="Enter Name">
							</div>
							<div class="col-sm-12">
								<label>Transaction Type:</label>
								<select name="transaction" class="form-control">
								    <option value="TRANSFER">A.O. 8 - Order of Transfer</option>
									<option value="MAROCert">MARO Certification</option>
								</select>
								
							</div>
											
							<div class="form-group col-sm-12">
								<label>Date Filed:</label>
								<input type="date" class="form-control" name="datefiled" >
							</div>
							<div class="col-sm-12">
								<label><input type="checkbox" name="urgent" value="Y">Urgent</label>
							</div>
							<div class="form-group col-sm-12">
								<label>Reference No.:</label>
								<input type="text" class="form-control" name="referenceno">
							</div>
							
							<div class="col-sm-12">
								<label>Submitted documents:</label><br>
								<div class="col-sm-6">
									<label><input type="checkbox" name="amortization" value="Y">Certificate of Full Payment of Amortization</label><br>
									<label><input type="checkbox" name="nia" value="Y">Certification regarding Full Payment of Irrigation Fees</label>
									<label><input type="checkbox" name="loancert" value="Y">Certification regarding Loans</label>
									<label><input type="checkbox" name="taxclearance" value="Y">Tax clearance</label>
									<label><input type="checkbox" name="affidavittransferor" value="Y">Affidavit of the transferor</label>
								</div>
								<div class="col-sm-6">
									<label><input type="checkbox" name="affidavitaggregate" value="Y">Affidavit of Aggregate Area</label><br>
									<label><input type="checkbox" name="taxreturn" value="Y">Certified copy of Income Tax Return</label>
									<label><input type="checkbox" name="rescert" value="Y">Residence Certificate</label>
									<label><input type="checkbox" name="assessor" value="Y">Certification by the Provincial Assessor's Office</label>
								</div>
							</div>
							<div class="form-group col-sm-12">
								<label>Municipal Office:</label>
								<input type="text" class="form-control" name="municipalname" readonly>
							</div>
							<div class="form-group col-sm-12">
								<label>Provincial Office:</label>
								<input type="text" class="form-control" name="provincialname" readonly>
							</div>
							<div class="form-group col-sm-12">
								<label>Regional Office:</label>
								<input type="text" class="form-control" name="regionalname" readonly>
							</div>
							<div class="form-group col-sm-12">
								<label for="comment">Remarks:</label>
								<textarea class="form-control" rows="5" name="remarks"></textarea>
							</div>
							<div class="form-group col-sm-12">
								<label>Prepared by</label>
								<input type="text" class="form-control" name="preparedby" placeholder="Enter fullname" >
							</div>
							
							
							
					</fieldset>
					<div class="col-xs-12"><button type="button" class="btn btn-info btn-sm" onclick="showmap(this.form)">View Map</button></div>
					
					<div class="col-xs-12">
					<br>
						<button name="butsave" type="submit" class="btn btn-primary" id="savebut">Save</a>
						<button name="butupdate" type="button" onclick="updatethis(this.form)" class="btn btn-success" id="updatebut">Update</a>
						<button name="butprint" type="button" onclick="printthis(this.form)" class="btn btn-primary" id="printbut">Print</a>	
						<button name="butcancel" type="button" onclick="cancelthis(this.form)" class="btn btn-default" id="cancelbut">Cancel</a>
						<button name="butclose" type="button" onclick="closethis(this.form)" class="btn btn-danger" id="closebut">Close</a>	
					</div>	
			</form>
			<div class="col-xs-6" id="divattachment">
						<div class="col-xs-12">
							<h5>Attachment/s:</h5>
							<button type="button" class="btn btn-default" onclick="addimages();return false;" id="addimage">Add Image (max image size is 20mb)</button>
							<br><br>
						</div>
						<div class="col-xs-12">
							<div id="divimages"></div>
						</div>
			</div>
			<div class="col-xs-6" id="marpocert">
						<div class="col-xs-12">
						
							<h5>MARPO Certification:</h5>
							<button class="btn btn-default btn-xs marpo" type="button" onclick="UploadMARPOCert()">Create MARPO Certification</button>
							<div class="col-xs-12" id="divdocs"></div>
							
							<br>
							
								<label style="font-style:italic">Please enable the popup window</label>
							<br><br>
						
						</div>
						
			</div>
		</div>
	  
		
		
	   
	</div>
</div>
<div id="header"></div>


<div id="mySave" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      
      <div class="modal-body">
		  <img class="img-responsive center-block" alt="saving" src="images/saving.gif">
		  <div class="col-xs-12" style="text-align:center"><span>Saving Please Wait</span></div>
	  </div>
      
    </div>

  </div>
</div>
<div id="myMap" class="modal" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
		<div class="row"><div id="map" class="map"></div><div id="popup"></div></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
</div>
<div id="myRoute" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      
      <div class="modal-body">
		  <img class="img-responsive center-block" alt="routing" src="images/saving.gif">
		  <div class="col-xs-12" style="text-align:center"><span>Routing Please Wait</span></div>
	  </div>
      
    </div>

  </div>
</div>
<div id="mySign" class="modal fade" role="dialog">
  <div class="modal-dialog modal-sm">

    <!-- Modal content-->
    <div class="modal-content">
      
      <div class="modal-body">
		  <img class="img-responsive center-block" alt="sigimage" src="images/saving.gif">
		  <div class="col-xs-12" style="text-align:center"><span>Signing Please Wait</span></div>
	  </div>
      
    </div>

  </div>
</div>

<section><div id="attachmentdiv"></div></section>
</body>
<script src="jquery.min.js"></script>
<script src="bootstrap.min.js"></script>
<script src="jquery.dataTables.min.js"></script>
<script src="Buttons/js/buttons.print.min.js"></script>
<script src="jquery.toaster.js"></script>
<script src="bootbox.min.js"></script>
<script src="ol.js"></script>
<script src="main1.js"></script>
<script src="ckeditor/build/ckeditor.js"></script>
<script>
ClassicEditor
			.create( document.querySelector( '#editor' ), {
				
				toolbar: {
					items: [
						'heading',
						'|',
						'bold',
						'italic',
						'link',
						'bulletedList',
						'numberedList',
						'|',
						'outdent',
						'indent',
						'|',
						'imageUpload',
						'blockQuote',
						'insertTable',
						'mediaEmbed',
						'undo',
						'redo',
						'CKFinder',
						'alignment',
						'fontBackgroundColor',
						'fontColor',
						'fontSize',
						'fontFamily',
						'highlight',
						'horizontalLine',
						'pageBreak',
						'removeFormat',
						'specialCharacters',
						'strikethrough',
						'subscript',
						'superscript',
						'underline',
						'lineHeight'
					]
				},
				language: 'en',
				image: {
					toolbar: [
						'imageTextAlternative',
						'imageStyle:full',
						'imageStyle:side'
					]
				},
				table: {
					contentToolbar: [
						'tableColumn',
						'tableRow',
						'mergeTableCells',
						'tableCellProperties',
						'tableProperties'
					]
				},
				licenseKey: '',
				ckfinder: {openerMethod: 'popup'}
				
			} )
			.then( editor => {
				window.editor = editor;
				
			} )
			.catch( error => {
				console.error( error );
			} );
var tupdate = false;
let stemplate ='';
let xlocation = '';
let xoffice ='';
function uploadtemplate(){
let tk = qs['tk'];
$.get('darmoController.php',{"trans":"loadtemplate","tk":tk}, function (d){
		let data = d['template'];
		stemplate = data;
	},'json');
}
function getlocation(){
let tk=qs['tk'];
$.get('darmoController.php',{"trans":"getlocation","tk":tk,"officecode":soffice}, function (d){
		let data = d['location'];
		xlocation = data;
	},'json');
}
function getofficename(){
let tk=qs['tk'];
$.get('darmoController.php',{"trans":"getofficename","tk":tk,"officecode":soffice}, function (d){
		let data = d['officename'];
		xoffice = data;
	},'json');
}
function closeck(){
let iddcrform = document.getElementById('ckiddcrform').value;
	getcert(iddcrform);
document.getElementById('list').style.display = "block";
document.getElementById('ckeditor').style.display = "none";
}
function UploadMARPOCert(){
document.getElementById('list').style.display = "none";
document.getElementById('ckeditor').style.display = "block";
document.body.scrollTop = 0; // For Safari
document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
let iddcrform = document.getElementById('ckiddcrform').value;
let x = document.getElementById('form'+iddcrform);
let xowner = x.elements.namedItem('registeredowners').value;
let xtd = x.elements.namedItem('tdno').value;
let xtitleno = x.elements.namedItem('titleno').value;
let xarea = x.elements.namedItem('area').value;
let xpropertylocation = x.elements.namedItem('propertylocation').value;
let xdate = new Date();
let xday = xdate.toLocaleString('default',{day:'numeric'});
let xmonth = xdate.toLocaleString('default',{month:'long'});
let xyear = xdate.toLocaleString('default',{year:'numeric'});
let content = stemplate.replace("$owner",xowner);
let xsub = "th";
if (xday==1 ||  xday==21 || xday==31) { xsub="st";}
else if (xday==2 || xday==22) {xsub="nd";}
else if (xday==3 || xday==23) {xsub="rd";}
else if (xday>=4 && xday<=20) {xsub="th";}
else if (xday>=24 && xday<=30) {xsub="th";}
xarea = parseFloat(xarea) /10000;
content = content.replace("$title",xtitleno);
content = content.replace("$area",xarea);
content = content.replace("$propertylocation",xpropertylocation);
content = content.replace("$tdno",xtd);
content = content.replace("$day",xday+xsub);
content = content.replace("$month",xmonth);
content = content.replace("$year",xyear);
content = content.replace("$municipaladdress",xlocation);
content = content.replace("$maro",fullname);

editor.setData(content);
}
function startload() {
	var caption = "DAR Region XI";
	var today = new Date();
	var asDate = new Date();
	var options = { year: 'numeric', month: 'long', day: 'numeric' };
	var stoday = today.toLocaleDateString("en-US", options);
	
	
	var tk=qs['tk'];
	var table = $('#ds').DataTable( {
		"ajax": "darmoController.php?trans=getdetails&tk="+tk+"&officecode="+soffice,
		"dom": 'lfrtBip', "destroy": true,
		"buttons": [
            "copy", 
			{extend:"excelHtml5","title" : "List of Encoded Applications", "messageTop": caption, "messageBottom": "\n Prepared by: "+ fullname + " " +stoday, "footer":true}, 
			{extend: 'pdf', 
			title : 'List of Encoded Applications'
			, messageTop: caption, messageBottom: '\n Prepared by: '+ fullname + ' ' +stoday, footer:true},
			{extend: 'print',
			title : 'List of Encoded Applications',
			 messageTop: caption, messageBottom: '\n Prepared by: '+ fullname + ' ' +stoday, footer:true
			
			}
        ],
        "columns": [
            {"className":      'details-control',
												 "orderable":      false,
												 "data":           null,
												 "defaultContent": ''},
			{ "data": "iddcrform"},
			{ "data": "applicant"},
			{ "data": function (d) {return trans(d);}},
			{ "data": "datefiled"},
			{"className":'deleteclassbutton1',"defaultContent": '<button type="button" data-toggle="tooltip" title="delete" class="btn btn-link" ><span class="glyphicon glyphicon-remove"></span></button>'},	
			{"className":'remarksclassbutton',"defaultContent": '<button type="button" data-toggle="tooltip" title="For DARPO" class="btn btn-link" ><span class="glyphicon glyphicon-send"></span></button>'},
			{ "data": function (d) {return actions(d);}}

        ],
        "order": [[3, 'desc']]
    } );
	
	$('#ds tbody').on( 'click', 'td.deleteclassbutton1', function (o) {
        var tr = $(this).closest('tr');
        var row = table.row( tr );
		let xrow = row.data();
		let trans = xrow['transaction'];
		if (trans=='TRANSFER'){deletethis2(row.data());} else { bootbox.alert('Record cannot be deleted');}
	} );
	$('#ds tbody').on( 'click', 'td.remarksclassbutton', function (o) {
        var tr = $(this).closest('tr');
        var row = table.row( tr );
		let xrow = row.data();
		let trans = xrow['transaction'];
		if (trans=='TRANSFER') {DARPOthis(row.data());} else { bootbox.alert('Record cannot be forwarded to DARPO');}
	} );
	$('#ds tbody').on('click', 'td.details-control', function () {
		
        var tr = $(this).closest('tr');
        var row = table.row( tr );
 
        if ( row.child.isShown() ) {
            
            row.child.hide();
            tr.removeClass('shown');
			
			
        }
		
        else {
            if ( table.row( '.shown' ).length ) {
                  $('.details-control', table.row( '.shown' ).node()).click();
			}
            row.child( format(row.data())).show();
            tr.addClass('shown');
			getchild(row.data());
        }
		
    } );
	
	
	$.get("darmoController.php",{trans:"offices","tk":tk,"officecode":soffice},function(data){
										if (data['error']) {
											$.toaster({ priority : 'danger', title : 'DARMO', message : 'Invalid User'});
											document.getElementById('list').style.display="none";
											
										} else {
										var municipal = data['municipal'];
										var provincial = data['provincial'];
										var regional = data['regional'];
										document.getElementsByName('municipalname')[0].value = municipal['officename'];
										document.getElementsByName('provincialname')[0].value = provincial['officename'];
										document.getElementsByName('regionalname')[0].value = regional['officename'];
										document.getElementsByName('officecode')[0].value = soffice;
										$(".municipal").val(data['idofficemunicipal']);
										$(".provincial").val(data['idofficeprovincial']);
										$(".regional").val(data['idofficeregional']);
										}
										},'json');
	 
	startattachment();
	uploadtemplate();
	getlocation();
	getofficename();
	initload();
}
function actions(row){
	var buttons ='';
	let iddcrform = "'"+row['iddcrform']+"'";                   
	
	//unremarks this if municipal is required 
	                         
	var municipalkey = "'"+row['idtrackform']+"','"+row['iddcrform']+"','"+row['municipal']+"','"+row['details']+"','"+row['provincialname']+"'";
	
		buttons ='<button type="button" onclick="appeals('+municipalkey+')" data-toggle="tooltip" title="Disapprove" class="btn btn-link"><span class="glyphicon glyphicon-thumbs-down"></span></button>';
		if (row['transaction']=='MAROCert'){
			buttons ='';
			if (row['signedmarpocert']==1){
				
				let params= "'"+row['idtrackform']+"','"+row['iddcrform']+"','"+row['details']+"','"+row['municipalname']+"'";
				buttons ='<button type="button" onclick="completed('+params+')" data-toggle="tooltip" title="Tag Completed" class="btn btn-link"><span class="glyphicon glyphicon-ok-circle"></span></button>';
			}
		}
	return buttons;
	
	
}
function trans(r){
	let trans = r['transaction'];
	if (trans == 'TRANSFER') {trans = 'A.O. 8 - Order of Transfer'};
	if (trans == 'MAROCert') {trans = 'MARO Certification'};
	return trans;
}



function deletethis2(data){
bootbox.confirm({
    message: 'Delete Tracking No. '+ data['iddcrform'] +'?',
    buttons: {
        confirm: {
            label: 'Yes',
            className: 'btn-danger'
        },
        cancel: {
            label: 'No',
            className: 'btn-default'
        }
    },
    callback: function (result) {
        if (result){
			var tk=qs['tk'];
			{$.get("darmoController.php",{trans:"delete",iddcrform:data['iddcrform'],"tk":tk},function(data){
										if (data['iddcrform']>-1){
											$.toaster({ priority : 'success', title : 'Encoded', message : 'Record Deleted'});
									        $('#ds').DataTable().ajax.reload(null,false);} else { $.toaster({ priority : 'danger', title : 'Encoded', message : 'Record cannot be deleted'});}
							        },'json');
					}

		}
    }
});

}
function format(row){
var iddcrform = row['iddcrform'];
var track = "track"+row['iddcrform'];

var elem = document.getElementById(iddcrform);
if (elem){
  elem.parentNode.removeChild(iddcrform);
}
var elem2 = document.getElementById(track);
if (elem2){
  elem2.parentNode.removeChild(track);
}
  return '<div class="maindiv"><div class="col-xs-12" id="'+iddcrform+'"></div><div class="col-xs-12" id="'+track+'"></div></div>';
}
function onchangeapplicant(x){
	document.getElementById('ckapplicant').innerHTML = x.value;
}
function onchagelocation(x){
	document.getElementById('cklocation').innerHTML = x.value;
}
function getchild(data){
var iddcrform = '#'+data['iddcrform'];

var tform = document.getElementById('form'+data['iddcrform']);
if (tform){
	tform.parentNode.removeChild('form'+data['iddcrform']);
}
var nform = $('#entryform').clone(true).prop('id','form'+data['iddcrform']);
nform.appendTo( iddcrform );
var x = document.getElementById('form'+data['iddcrform']);
	document.getElementById('ckiddcrform').value = data['iddcrform'];
	document.getElementById('cktk').value = qs['tk'];
	document.getElementById('ckapplicant').innerHTML = data['applicant'];
	document.getElementById('cklocation').innerHTML = data['propertylocation'];
	
	x.elements.namedItem('tk').value=qs['tk'];
	x.elements.namedItem('trans').value='UPDATE';
	x.elements.namedItem('iddcrform').value=data['iddcrform'];
	x.elements.namedItem('municipal').value=data['municipal'];
	x.elements.namedItem('provincial').value=data['provincial'];
	x.elements.namedItem('regional').value=data['regional'];
	x.elements.namedItem('municipalname').value=data['municipalname'];
	x.elements.namedItem('provincialname').value=data['provincialname'];
	x.elements.namedItem('regionalname').value=data['regionalname'];
	x.elements.namedItem('address').value= data['address'];
	x.elements.namedItem('applicant').value= data['applicant'];
	x.elements.namedItem('email').value= data['email'];
	x.elements.namedItem('cellno').value= data['cellno'];
	x.elements.namedItem('telno').value= data['telno'];
	x.elements.namedItem('transaction').value= data['transaction'];
	x.elements.namedItem('propertylocation').value= data['propertylocation'];
	x.elements.namedItem('longtitude').value= data['longtitude'];
	x.elements.namedItem('latitude').value= data['latitude'];
	x.elements.namedItem('referenceno').value= data['referenceno'];
	x.elements.namedItem('transaction').value= data['transaction'];
	x.elements.namedItem('remarks').value= data['remarks'];
	x.elements.namedItem('preparedby').value= data['preparedby'];
	x.elements.namedItem('datefiled').value= data['datefiled'];
	if (data['urgent']=='Y'){
		x.elements.namedItem('urgent').checked = true;
	} else {
		x.elements.namedItem('urgent').checked = false;
	}
	if (data['amortization']=='Y'){
		x.elements.namedItem('amortization').checked = true;
	} else {
		x.elements.namedItem('amortization').checked = false;
	}
	if (data['nia']=='Y'){
		x.elements.namedItem('nia').checked = true;
	} else {
		x.elements.namedItem('nia').checked = false;
	}
	if (data['taxclearance']=='Y'){
		x.elements.namedItem('taxclearance').checked = true;
	} else {
		x.elements.namedItem('taxclearance').checked = false;
	}
	if (data['affidavittransferor']=='Y'){
		x.elements.namedItem('affidavittransferor').checked = true;
	} else {
		x.elements.namedItem('affidavittransferor').checked = false;
	}
	if (data['affidavitaggregate']=='Y'){
		x.elements.namedItem('affidavitaggregate').checked = true;
	} else {
		x.elements.namedItem('affidavitaggregate').checked = false;
	}
	if (data['loancert']=='Y'){
		x.elements.namedItem('loancert').checked = true;
	} else {
		x.elements.namedItem('loancert').checked = false;
	}
	if (data['taxreturn']=='Y'){
		x.elements.namedItem('taxreturn').checked = true;
	} else {
		x.elements.namedItem('taxreturn').checked = false;
	}
	if (data['rescert']=='Y'){
		x.elements.namedItem('rescert').checked = true;
	} else {
		x.elements.namedItem('rescert').checked = false;
	}
	if (data['assessor']=='Y'){
		x.elements.namedItem('assessor').checked = true;
	} else {
		x.elements.namedItem('assessor').checked = false;
	}
	
	x.elements.namedItem('registeredowners').value= data['registeredowners'];
	x.elements.namedItem('titleno').value= data['titleno'];
	x.elements.namedItem('area').value= data['area'];
	x.elements.namedItem('tdno').value= data['tdno'];
	x.elements.namedItem('instrument').value= data['instrument'];
	x.elements.namedItem('transferor').value= data['transferor'];
	x.elements.namedItem('transferees').value= data['transferees'];
	x.elements.namedItem('dateconveyance').value= data['dateconveyance'];
	x.elements.namedItem('placeconveyance').value= data['placeconveyance'];
	x.elements.namedItem('docno').value= data['docno'];
	x.elements.namedItem('pageno').value= data['pageno'];
	x.elements.namedItem('bookno').value= data['bookno'];
	x.elements.namedItem('yrnotarized').value= data['yrnotarized'];
	x.elements.namedItem('notarypublic').value= data['notarypublic'];
	
	
	x.elements.namedItem('myfields').disabled = true;
	
	x.elements.namedItem('butupdate').style.display='inline';
	x.elements.namedItem('butsave').style.display='none';
	x.elements.namedItem('butcancel').style.display='none';
	x.elements.namedItem('butclose').style.display='none';
	x.elements.namedItem('butprint').style.display='none';
	
	
    
	var nform = $('#divattachment').clone(true);
	nform.appendTo( iddcrform );
	document.getElementById('divattachment').style.display = "block";
	document.getElementById('keyvalue').value = data['iddcrform'];
	document.getElementById('keyname').value = 'iddcrform';
	getattachments(data['iddcrform']);
	let xorderform = $('#marpocert').clone(true);
	xorderform.appendTo( iddcrform );
	document.getElementById('marpocert').style.display ="block";
	getcert(data['iddcrform'])
	initload();
	getcase(data['iddcrform'],data['municipal'],data['regional']);
	
}
function getcase(iddcrform,municipal,regional){
var tk=qs['tk'];
$.get("darpoController.php",{trans:"getcase","tk":tk,"iddcrform":iddcrform,"municipal":municipal,"regional":regional},function(data){
										var nlast = data['trackform'].length-1;
										
										var bfound = false;
										var scontent ='';
										
										var nlength = data['trackform'].length;
										var today = new Date(); 
										var municipal = data['municipal'];
										var regional = data['regional'];
										for(i=0; i < nlength; i++){
										
											var row = data['trackform'][i];
											bfound = true;
											if (nlast == i){
												scontent +="<div class='col-xs-12 well'>";
												var startdate = new Date(row['startdate']);
												var duration = datedifference(startdate, today,15,'DAYS')
												scontent += "<label><small>Status:</small> "+row['status']+"  <small>Date :</small> "+row['startdate']+"  <small>Duration:</small> "+ duration+ "</label><br>";
												scontent += "<label>Details :</label>";
												var sdetails = row['details'];
												if (!sdetails) {sdetails ='';}
												scontent += '<p>'+sdetails+'</p>';
												scontent += "</div>";
												
												iddcrform = row['iddcrform'];
												scontent += "</div>";
											} else {
												scontent += '<div class="col-xs-12 well">';
												var startdate = new Date(row['startdate']);
												var enddate = new Date(row['enddate']);
												var duration = datedifference(startdate, enddate);
												let ncounter = i+1;
												scontent +="<label><small>"+ncounter+". Office: </small><span class='label label-info'>"+row['officename']+"</span></label><br>";
												scontent += "<label><small>Status:</small> "+row['status']+"  <small>Period from: </small>"+row['startdate']+" to "+ row['enddate']+ "  <small> Elapsed Time:</small> "+ duration+ "</label><br>";
												if (row['firstseen']) {scontent += "<label><small>First Seen by:</small> <span class='label label-default'> "+row['firstseen']+" </span> - ";}
												scontent += "<label><small>Processed by: </small></label> <span class='label label-default'> "+row['fullname']+" </span><br>";
												scontent += "<label>Details: </label>";
												scontent += "<p>"+row['details']+"</p>";
												scontent += '</div>';
											}
											
										}
										if (bfound){
												document.getElementById('track'+iddcrform).innerHTML = scontent;
												
											}
										},'json');
}
function additem(){
	
	
	$('#ds').DataTable().ajax.reload(false,false);
	document.getElementById('list').style.display="none";
	document.getElementById('details').style.display="block";
	var x = document.getElementById('entryform');
	x.elements.namedItem('myfields').disabled = false;
	x.elements.namedItem('iddcrform').value = -1;
	x.elements.namedItem('address').value = '';
    x.elements.namedItem('referenceno').value= '';
	x.elements.namedItem('applicant').value= '';
	x.elements.namedItem('urgent').checked= false;
	x.elements.namedItem('datefiled').value= configuredate();
	x.elements.namedItem('dateconveyance').value= configuredate();
	x.elements.namedItem('longtitude').value = 0;
	x.elements.namedItem('latitude').value = 0;
	x.elements.namedItem('transaction').selectedIndex=0;
	x.elements.namedItem('propertylocation').value= '';
	x.elements.namedItem('email').value= '';
	x.elements.namedItem('cellno').value= '';
	x.elements.namedItem('telno').value= '';
	x.elements.namedItem('amortization').checked= false;
	x.elements.namedItem('nia').checked= false;
	x.elements.namedItem('taxclearance').checked= false;
	x.elements.namedItem('affidavittransferor').checked= false;
	x.elements.namedItem('affidavitaggregate').checked= false;
	x.elements.namedItem('loancert').checked= false;
	x.elements.namedItem('taxreturn').checked= false;
	x.elements.namedItem('rescert').checked= false;
	x.elements.namedItem('assessor').checked= false;
	x.elements.namedItem('remarks').value= '';
	x.elements.namedItem('preparedby').value= fullname;
	
	x.elements.namedItem('registeredowners').value= '';
	x.elements.namedItem('titleno').value= '';
	x.elements.namedItem('area').value= 0;
	x.elements.namedItem('tdno').value= '';
	x.elements.namedItem('instrument').value= '';
	x.elements.namedItem('transferor').value= '';
	x.elements.namedItem('transferees').value= '';
	x.elements.namedItem('dateconveyance').value= configuredate();
	x.elements.namedItem('placeconveyance').value= '';
	x.elements.namedItem('docno').value= '';
	x.elements.namedItem('pageno').value= '';
	x.elements.namedItem('bookno').value= '';
	x.elements.namedItem('yrnotarized').value= 0;
	x.elements.namedItem('notarypublic').value= '';
	
	x.elements.namedItem('trans').value='ADD';
	x.elements.namedItem('butupdate').style.display='none';
	x.elements.namedItem('butsave').style.display='inline';
	x.elements.namedItem('butcancel').style.display='none';
	x.elements.namedItem('butprint').style.display='none';
	
	x.elements.namedItem('myfields').disabled = false;
	x.elements.namedItem('butclose').style.display='inline';
	
	document.getElementById('divattachment').style.display = "none";
	
}
function updatethis(thisform){
thisform.elements.namedItem('butupdate').style.display='none';
thisform.elements.namedItem('butprint').style.display='none';
thisform.elements.namedItem('butsave').style.display='inline';
thisform.elements.namedItem('butcancel').style.display='inline';
thisform.elements.namedItem('myfields').disabled = false;

	
	return false;
	
}
function showmap(thisform){
$("#myMap").modal("show");
	var lat = thisform.elements.namedItem('latitude').value;
	var lon = thisform.elements.namedItem('longtitude').value;
	
	var propertylocation = thisform.elements.namedItem('propertylocation').value;
	if (lat == 0 && lon == 0){
		lat = 7.07221;
		
		//7.0567022;
		//
		lon = 125.52210;
		//125.6016536;
		//
		propertylocation = "Department Of Agrarian Reform Regional Office XI";
		
	}
	
	
	
	var layer = new ol.layer.Vector({
     source: new ol.source.Vector({
         features: [
             new ol.Feature({
                 geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat]))
             })
         ]
			 
		})
		
	 });
	var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([lon, lat]),
          zoom: 17
        })
		
      });
	
	
	 var container = document.getElementById('popup');
	 

	var overlay = new ol.Overlay({
     element: container,
     autoPan: true,
     autoPanAnimation: {
         duration: 250
     }
 });
 
	map.addOverlay(overlay);
	container.innerHTML = '<img src="images/marker.png"><b>'+propertylocation+'</b>';
	overlay.setPosition(ol.proj.fromLonLat([lon, lat]));

}
function renderthis(){
	let params = 'menubar=no,width=0, height=0`,location=no, status=no, toolbar=no';
	document.getElementById('lsave').value = "0";
	window.open('','pdfwindow',params);
	document.getElementById("renderform").submit();
	
}
function saveCert(){
	let params = 'menubar=no,width=0, height=0`,location=no, status=no, toolbar=no';
	document.getElementById('lsave').value = "1";
	window.open('','pdfwindow',params);
	document.getElementById("renderform").submit();
	bootbox.alert('MARPO Certification saved');
	
}
function getcert(iddcrform){
let tk = qs['tk'];

$.get("darmoController.php",{"trans":"getcert","tk":tk,"iddcrform":iddcrform},function(data){
											let marpocert = data['marpocert'];
											let scontent ='';
											if (marpocert!==''){
												let iddcrform = "'"+data['iddcrform']+"'";
												let docdet ="'"+data['marpocert']+"','"+data['iddcrform']+"'";
												
												scontent += '<span class="glyphicon glyphicon-file"></span><button type="button" onclick="showpdf('+iddcrform+')" class="btn btn-link">'+data['marpocert']+'</button>';
												if (data['signedmarpocert']=='0'){
													scontent += '<button type="button" onclick="signpdf('+docdet+')" class="btn btn-primary btn-xs">Sign</button>';
												}
												scontent += '<button type="button" onclick="deletepdf('+iddcrform+')" class="btn btn-danger btn-xs">Remove</button><br>';
												
											}
											
											document.getElementById('divdocs').innerHTML = scontent;
										},'json');
}
function showpdf(iddcrform){
let params = 'menubar=no,width=0, height=0`,location=no, status=no, toolbar=no';
let tk=qs['tk'];
	window.open('darmoController.php?iddcrform='+iddcrform+"&tk="+tk+"&trans=showpdf",'pdfwindow',params);
}
function signpdf(filename,iddcrform){
let keyword = fullname;
$("#mySign").modal("show");
$.get("searchpdfController2.php",{"tk":tk,"keyword":keyword,"filename":filename,"iddcrform":iddcrform},function(data){
											let page = data;
											if(page['pagenumber']>0 ){
												
													let x = page['cX'];
													let y = page['cY'];
													let filename = page['filename'];
													let signature = signimage;
													let iddcrform = page['iddcrform'];
													let pagenumber = page['pagenumber'];
													let idorderdoc = page['idorderdoc'];
													if (!signature){
														$("#mySign").modal("hide");
														bootbox.alert('Failed to sign. User signature not registered');
														
													} else {
														let tk = qs['tk'];
														$.get("signdocController2.php",{"tk":tk,"x":x,"y":y,"filename":filename,"pagenumber":pagenumber,"sigimage":signature,"iddcrform":iddcrform,"tk":tk,"fullname":fullname},function(data){
															$("#mySign").modal("hide");
															bootbox.alert('Document signed');
															getcert(data['iddcrform']);
															
														},'json');
													}
											
											
											}else {
													$("#mySign").modal("hide");
													bootbox.alert('Failed to sign. Signatory name not found');
													
											}},'json');


}
function deletepdf(iddcrform){
let tk = qs['tk'];
bootbox.confirm({
    message: 'Delete this document?',
    buttons: {
        confirm: {
            label: 'Yes',
            className: 'btn-danger'
        },
        cancel: {
            label: 'No',
            className: 'btn-default'
        }
    },
    callback: function (result) {
        if (result){
			$.get("darmoController.php",{"trans":"deletepdf","tk":tk,"iddcrform":iddcrform},function(data){
											bootbox.alert('Document Deleted');
											getcert(data['iddcrform']);
											},'json');


		}
    }
});
}
function savethis(thisform){
var cont = 1;

	
	
	var xapplicant = thisform.elements.namedItem('applicant').value;
	var xpropertylocation = thisform.elements.namedItem('propertylocation').value;
	thisform.elements.namedItem('transaction1').value = thisform.elements.namedItem('transaction').value;
		
		if (!xapplicant) { $.toaster({ priority : 'danger', title : 'Application', message : 'Invalid Applicant Field'}); cont = -1;} 
		if (!xpropertylocation) { $.toaster({ priority : 'danger', title : 'Application', message : 'Invalid Property location Field'}); cont = -1;} 
	
	
	if (cont > -1){
		
		$("#mySave").modal("show");
		var data = $(thisform).serialize();
		document.getElementById('savebut').style.display ="none";
		$.ajax({
            url: 'darmoController.php',
			data: data,
			cache: false,
			contentType: false,
			processData: false,
			dataType: 'json',
			type: 'GET',
            success: function(data) {
			
				    if (data["iddcrform"] > -1){
							
						//$('#ds').DataTable().ajax.reload(false,false);
							
						//$("#detailsModal").modal("hide");	
						$.toaster({ priority : 'success', title : 'Application', message : 'Applicantion of '+data['applicant']+' saved.'});
						$('.iddcrform').val(data['iddcrform']);
						$('.tk').val(qs['tk']);
						$('.trans').val('UPDATE');
						
						
						document.getElementById('divattachment').style.display = "block";
						document.getElementById('keyvalue').value = data['iddcrform'];
						document.getElementById('keyname').value = 'iddcrform';
						getattachments(data['iddcrform']);
						tupdate = true;
						$('#ds').DataTable().ajax.reload(null,false);
						document.getElementById('myfields').disabled = true;
						document.getElementById('updatebut').style.display='inline';
						document.getElementById('savebut').style.display='none';
						document.getElementById('cancelbut').style.display='none';
						//document.getElementById('printbut').style.display='inline';
						
						
					} else {
						$.toaster({ priority : 'danger', title : 'Application', message : 'Saving Failed.  Please check details'});
						document.getElementById('savebut').style.display ="inline";
					}
					
					$("#mySave").modal("hide");
					
			}
		});
		
		//$("#officeModal").modal("hide");
		
	}
	return true;
}

function cancelthis(thisform){
	$('#ds').DataTable().ajax.reload(null,false);
	
}
function DARPOthis(data){
bootbox.confirm({
    message: 'For DARPO - Applicant: '+ data['applicant'] +'?',
    buttons: {
        confirm: {
            label: 'Yes',
            className: 'btn-danger'
        },
        cancel: {
            label: 'No',
            className: 'btn-default'
        }
    },
    callback: function (result) {
        if (result){
			$("#myRoute").modal("show");
			var tk=qs['tk'];
			var officename = data['municipalname'];
			{$.get("darmoController.php",{trans:"forDARPO",iddcrform:data['iddcrform'],idtrackform:data['idtrackform'],"provincial":data['provincial'],"officename":officename,"tk":tk},function(d){
											var officecode = d['officecode'];
											var role = d['role'];
											var iddcrform = d['iddcrform'];
											var officename = d['officename'];
											$.get("sendController.php",{"officecode":officecode,"role":role,"iddcrform":iddcrform,"officename":officename});
											$.toaster({ priority : 'success', title : 'DARMO', message : 'Record forwarded for DARPO'});
									        $('#ds').DataTable().ajax.reload(null,false);
											$("#myRoute").modal("hide");
										},'json');
			}

		}
    }
});
}
function closethis(thisform){
document.getElementById('details').style.display="none";
if (tupdate) {
	//$('#ds').DataTable().ajax.reload(false,false);
	tupdate = false;
}
document.getElementById('list').style.display="block";
}
function appeals(idtrackform,iddcrform,municipal,details,officename,thisform){
bootbox.confirm({
    message: 'Disapprove?',
    buttons: {
        confirm: {
            label: 'Yes',
            className: 'btn-danger'
        },
        cancel: {
            label: 'No',
            className: 'btn-default'
        }
    },
    callback: function (result) {
        if (result){
			if (thisform){
				
				details = thisform.elements.namedItem('details').value;
				
			}
			$("#myRoute").modal("show");
			var tk=qs['tk'];
			{$.get("darmoController.php",{trans:"appeals","iddcrform":iddcrform,"idtrackform":idtrackform,"municipal":municipal,"details":details,"tk":tk},function(d){
											var iddcrform = d['iddcrform'];
											$.toaster({ priority : 'success', title : 'DARMO', message : 'Record Tagged Disapprove'});
											let officecode =d['officecode'];
											let role = d['role'];
											let officename = d['officename'];
											$.get("sendController.php",{"trans":"disapproved2","officecode":officecode,"role":role,"iddcrform":iddcrform,"officename":officename});

									        $('#ds').DataTable().ajax.reload(null,false);
											$("#myRoute").modal("hide");
										},'json');
			}

		}
    }
});
}
function completed(idtrackform,iddcrform,details,officename,thisform){
bootbox.confirm({
    message: 'Tag as Completed?',
    buttons: {
        confirm: {
            label: 'Yes',
            className: 'btn-danger'
        },
        cancel: {
            label: 'No',
            className: 'btn-default'
        }
    },
    callback: function (result) {
        if (result){
			if (thisform){
				
				details = thisform.elements.namedItem('details').value;
				
			}
			$("#myRoute").modal("show");
			var tk=qs['tk'];
			{$.get("darmoController.php",{trans:"completed","iddcrform":iddcrform,"idtrackform":idtrackform,"officecode":soffice,"details":details,"officename":officename,"tk":tk},function(d){
											var iddcrform = d['iddcrform'];
											var officecode = d['officecode'];
											var officename = d['officename'];
											
											$.get("sendController.php",{"officecode":officecode,"iddcrform":iddcrform,"officename":officename,"trans":"completed3"});

											$.toaster({ priority : 'success', title : 'DARMO', message : 'Record tagged as Completed'});
									        $('#ds').DataTable().ajax.reload(null,false);
											$("#myRoute").modal("hide");
										},'json');
			}

		}
    }
});
}
function refresh(){
	$('#ds').DataTable().ajax.reload(null,false);
}
</script>
<script src="attachment.js"></script>